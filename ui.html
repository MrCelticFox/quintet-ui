<html>

<head>
    <meta charset="UTF-8" />
    <title>COMP30050 Project UI</title>
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Varela+Round">
    <link rel="stylesheet" href="/static/css/main.css">

    <script type="text/javascript">
        var ws;

        function init() {
            console.log("init.");
            var response = document.getElementById("response");
            var status = document.getElementById("status");
            var numClients = 0;
            var numSenders = 0;

            function onOpen() {
                status.innerText = "connected";
            };

            function onClose() {
                status.innerHTML = "connection closed";
            };

            function updateStatus() {
                status.innerHTML = "connected<br>(" + numClients + " browsers)";
                return;
            };

            function onMessage(e) {
                var m = JSON.parse(e.data);
                if (m.NumClients != null) {
                    numClients = m.NumClients;
                    updateStatus();
                    return;
                }

                console.log(m);
                var md = document.createElement("div");
                switch (m.MessageType) {
                    case "":
                    default:
                        return;
                    case "InputMeta":
                        md.innerHTML = "<table>" +
                            "<tr class='messageType'><th>Response Type:</th><td> Meta Information about Input </td></tr>" +
                            "<tr class='gist'><th>Title:</th><td>" + m.Gist + "</td></tr>" +
                            "<tr class='stat'><th>Body:</th><td>" + m.Body + "</td></tr>" +
                            "</table>";
                        break;
                    case "Result":
                        md.innerHTML = "<table>" +
                            "<tr class='messageType'><th>Response Type:</th><td> Solution Result </td></tr>" +
                            "<tr class='gist'><th>Title:</th><td>" + m.Gist + "</td></tr>" +
                            "<tr class='stat'><th>Body:</th><td>" + m.Body + "</td></tr>" +
                            "</table>";
                        break;
                }
                response.insertBefore(md, response.firstChild)
            };

            function connect() {
                if (ws != null) {
                    ws.close();
                    ws = null;
                }
                status.innerText = "connecting...";
                var url = "wss://{{.WSAddr}}/watch";
                ws = new WebSocket(url);
                ws.onopen = onOpen;
                ws.onclose = onClose;
                ws.onmessage = onMessage;
            };
            connect();
        }
    </script>
    <script type="text/javascript">
        var renderInputMeta = function(data) {
            console.log("stats load success");
            document.getElementById("num_students").innerText = data.NumberOfStudents;
            document.getElementById("num_projects").innerText = data.NumberOfProjects;
            document.getElementById("hottest_project").innerText = data.hottestProject;
            //need to render graph here if doing it
        }
        var renderResult = function(data) {
            console.log("solution load success");
            var tbody = document.createElement('tbody');
            for (var x in data.assignments) {
                var m = data.assignments[x];
                tbody.innerHTML += "<tr><td>" + m.student.Name + "</td><td>" + m.assignedProject.projectName + "</td></tr>";
            }
            document.getElementById('results_mapping').appendChild(tbody);
            document.getElementById('fitness').innerText = data.fitness;
            document.getElementById('energy').innerText = data.energyScore;
            document.getElementById('iterations').innerText = data.iterationPerformed;
            document.getElementById('strategy').innerText = data.solvingStrategy;
        }

        function demoLoad() {
            console.log("Loading solution and stats...")
            loadJSON(function(response) {
                var actual_JSON = JSON.parse(response);
                renderInputMeta(actual_JSON);
            }, '/static/demo/testinmeta.json');
            loadJSON(function(response) {
                var actual_JSON = JSON.parse(response);
                renderResult(actual_JSON);
            }, '/static/demo/testresult.json');
        }
        // Because Nils does not want to use jQuery at all
        function loadJSON(callback, filename) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', filename, true);
            xobj.onreadystatechange = function() {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }
    </script>
</head>

<body onLoad="demoLoad();">
    <!--onLoad="init();"-->
    <div id="banner">Project Results</div>

    <!-- TODO list
    Stats section:
        done - Output total number of students
        done - Output total number of projects
        done - Output must popular project
        - Display graph with project frequencies
        done - Output solution fitness
        done - Output solution energy score
        done - Output solution iterations performed
        done - Output solution solving strategy
    Solution section:
        done - Output table/list of mapping students to projects
        - Option to export and download results?
    -->

    <div id="main">
        <div class="block" id="solution">
            <div class="block-heading">Solution</div>
            <table id="results_mapping">
                <th>Student Name</th>
                <th>Project</th>
            </table>
        </div>

        <div class="block" id="stats">
            <div class="block-heading">Stats</div>
            <p class="stat"> Number of students: <span class="stat_answer" id="num_students"></span> </p>
            <p class="stat"> Number of projects: <span class="stat_answer" id="num_projects"></span> </p>
            <p class="stat"> Most popular project: <span class="stat_answer" id="hottest_project"></span> </p>
            <p class="stat"> Graph of project frequencies might go here:
                <div id="graph"></div>
            </p>
            <p class="stat"> Solution fitness: <span class="stat_answer" id="fitness"></span> </p>
            <p class="stat"> Solution energy: <span class="stat_answer" id="energy"></span> </p>
            <p class="stat"> Iterations performed: <span class="stat_answer" id="iterations"></span> </p>
            <p class="stat"> Solving strategy: <span class="stat_answer" id="strategy"></span> </p>
        </div>
    </div>
    <div id="status"></div>
    <div id="response"></div>
</body>

</html>